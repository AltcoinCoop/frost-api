language: minimal
notifications:
  slack:
    on_success: change
    on_failure: always
    on_error: always
    on_cancel: always
    secure: cwyGQ2d7/e8Jv3+wNJUBhKX/nmhBk7CpJKqI1QNtsh0cCEzDvstfL8aCMhHTVNw1ZLmb1U9JSk1lCFegSLnD/9BL58samafV76+6DORWRC1iT9GxC7D5he87Hz9uSiF/0iXyrqhmb7HwpAQ2eoXSvkvGdlpHGJLppuu3ep46vLflqqRHPqqvQJmCc/jkzeJ+ox1DSGZbSjDoNQO1AiDtLgUnZHkg9ZVDlD08BIrdjhFBkaiATCKhnYqO83PlHQTAbAA/MVMZH93xRtgcuZTFOonGa8Ty0mbMHWRNrfWaxyHua242q5H2leJ58VjPCdQmgLz3Fbo+YdQJ5eqGZGA9+xtN5p+PyWBbOZxCj+NRAjjSCTn9XAFe8KtaWxIYm5luBvHlX+c2OLCIzUMR2TV95AYzmtQh0G4TeMJz5Vzb0UOm9gA9K0DFm6UXTM1tAA1oyDHO05vFCrMl7VSptLeQs2HKsZYLvtjErsx/hnwisQnlqN5A7TeZrjQtt7yXBLwHbA88fe8UXFW+5MrGdCSlcF7QQCbewHY2Uunpog4ZEldCPOv0hHnrRELnIP6JJu9X0xX8FcfVMSV72wiv6+ZlN385jUAs77grGqDBwJSmpxvXhul9SA9KAZZ+Yd0pPHWzr/fd2xzrEkRy/jQEiDzjZc1gJ3KZFy7lUd3IPeqVUjM=

services:
- docker

env:
  REPO: poetapp/frost-api
  DOCKER_COMPOSE_VERSION: 1.23.2

before_install:
- sudo rm /usr/local/bin/docker-compose
- sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname
  -s)-$(uname -m)" -o /usr/local/bin/docker-compose
- sudo chmod +x /usr/local/bin/docker-compose

install:
- docker-compose up -d
- sleep 10

script:
- docker-compose exec frost-api npm run lint
- docker-compose exec frost-api npm run coverage

after:
- docker images

before_deploy:
- bash ./scripts/docker-build.sh

deploy:
- provider: script
  skip_cleanup: true
  script:
  - bash ./scripts/docker-push.sh
  on:
    all_branches: true
- provider: script
  skip_cleanup: true
  script:
  - docker-compose exec frost-api npx semantic-release --no-ci
  on:
    branch: master
