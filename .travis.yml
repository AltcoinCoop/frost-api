language: minimal

services:
  - docker

env:
  REPO: poetapp/frost-api
  DOCKER_COMPOSE_VERSION: 1.21.2

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

install:
  - docker-compose up -d
  - sleep 10

script:
  - docker-compose ps
  - docker-compose exec frost-api npm run lint
  - docker-compose exec frost-api npm run coverage

after:
  - docker images

before_deploy:
  - bash ./scripts/docker-build.sh

deploy:
  - provider: script
    skip_cleanup: true
    script:
    - bash ./scripts/docker-push.sh
    on:
      all_branches: true
  - provider: script
    skip_cleanup: true
    script:
      - docker-compose exec frost-api npx semantic-release --no-ci
    on:
      branch: master
