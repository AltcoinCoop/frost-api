# Frost API

[![Build Status](https://travis-ci.com/poetapp/frost-api.svg?token=FP3fasWY3bH5YsQqyXXz&branch=master)](https://travis-ci.com/poetapp/frost-api)
[![Renovate enabled](https://img.shields.io/badge/renovate-enabled-brightgreen.svg)](https://renovatebot.com/)
[![semantic-release](https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg)](https://github.com/semantic-release/semantic-release)
[![Join the chat at https://gitter.im/poetapp/Lobby](https://badges.gitter.im/poetapp/Lobby.svg)](https://gitter.im/poetapp/Lobby)

Po.et's API layer for publishers

- [Getting started](#getting-started)
    - [Requirements](#requirements)
    - [Install](#install)
    - [Development mode](#development-mode)
- [API](#api)
    - [Health check](#health-check)
    - [Accounts](#accounts)
    - [Works](#works)
- [Vault](#vault)
- [Consul](#consul)
- [Contributing](#contributing)
    - [Coverage](#coverage)
    - [Pull requests](#pull-requests)


## Getting started

### Requirements

* Node.js (see [`.nvmrc`](./.nvmrc) for the version to install)
* [Docker](https://docs.docker.com/install/) (with [docker-compose](https://docs.docker.com/compose/install/))
* Frost API token (sign up at [frost.po.et](https://frost.po.et) to create one)

### Install

```bash
git clone git@github.com:poetapp/frost-api.git
cd frost-api
npm i
```


### Development mode

```
npm run start:dev
```

When you start in development mode, all dependencies (MongoDB, Consul, Vault and Po.et Node) needed for Frost API are loaded by docker-compose. The Frost API will work with nodemon and you have the ability to debug on port 5858.

## API

We are using the [OpenAPI specification](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.1.md) to document the Frost API:
- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0

The purpose of the API is to:
- Facilitate the creation and maintenance of Frost accounts
- Enable Frost account holders to create and view their works on the Po.et Network

#### Tokens

There are four types of tokens generated by Frost (see [src/api/Tokens.ts](./src/api/Tokens.ts)). The two used in the Frost API methods described below are:
- API token - used for creating and reading works (see [Create work](#create-work), [Get all works](#get-all-works) and [Get work](#get-work) below)
- Login token - used when changing passwords (see [Password change](#password-change) below)
- Verify account token - used when verifying an email address (see [Verify account](#verify-account) below)
- Forgot password token - used when resetting a password (see [Password reset](#password-reset) below)

### Health check

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/healthCheck

### Accounts

#### Create account

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/createAccount

#### Verify account

When the user creates a new account the system automatically sends an email for the purpose of verifying the email address. This email contains a link with an embedded token, which the user only needs to click in order to verify the email address. Alternatively, the token can be passed programatically to the server:
- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/verifyAccount

#### Login to account

Authenticate with email address and password in order to receive a Login token.

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/loginAccount

#### Password reset

When the user forgets or loses the account password, a new one can be requested programatically.

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/passwordReset

An email is sent that contains a link with an embedded token, which the user can click in order to open the Frost website and set a new password.

#### Password change

Requires a Login token.

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/passwordChange

### Works

#### Create work

Requires an API token.

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/createWork

#### Get all works

Requires an API token.

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/getAllWorks

#### Get work

Requires an API token.

- https://app.swaggerhub.com/apis/po.et/frost-api/docs/1.0.0#/default/getWork

## [Vault](https://www.vaultproject.io/intro/getting-started/dev-server.html)

#### Start

```bash
vault server -config=config.hcl
```

#### Stop

```bash
ps ax | grep vault
kill -INT vault_pid
```

#### Get transit keys

```bash
curl --header "X-Vault-Token: ..." --request LIST http://localhost:8200/v1/transit/keys
```

#### Create s specific key

```bash
curl --header "X-Vault-Token: ..." --request POST  http://localhost:8200/v1/transit/keys/my-key
```

#### Read a specific key

```bash
curl --header "X-Vault-Token: ..." http://localhost:8200/v1/transit/keys/my-key
```

#### Error checking seal status

if you get an `Error checking seal status` error, check the status with:

```bash
curl https://127.0.0.1:8200/v1/sys/seal-status
```

## [Consul](https://www.consul.io/docs/agent/basics.html)

#### Start

```bash
consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -bind 127.0.0.1
```

#### Stop

```bash
ps ax | grep consul
kill -INT consul_pid
```

#### Delete data

> WARNING: only use in development mode.

```bash
curl -X DELETE 'http://localhost:8500/v1/kv/vault?recurse'
```

## Contributing

### Coverage
Coverage is generated with [Istanbul](https://github.com/istanbuljs/nyc). A more complete report can be generated by running `npm run coverage`, which will run `npm run coverage:unit` and `npm run coverage:integration` together. You may also execute these commands separately.

> Note: We are using our own forks of [nyc](https://github.com/istanbuljs/nyc) and [istanbul-lib-instrument](https://github.com/istanbuljs/istanbuljs/tree/master/packages/istanbul-lib-instrument) in order to add better support for TypeScript. We intend to contribute our forks back to nyc and istanbul-lib-instrument in order to make our solution available to the entire community. You can follow the issues in this [PR](https://github.com/poetapp/node/pull/230), and check the new PRs for [istanbul-lib-instrument](https://github.com/istanbuljs/istanbuljs/pull/204).

### Pull requests
The master branch is blocked - no one can commit to it directly. To contribute changes, branch off of master and make a pull request back to it. Travis CI will run all tests automatically for all submitted pull requests, including linting (`npm run lint`). You can run `npm run lint:fix` for quick, automatic lint fixes.
